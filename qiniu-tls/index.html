<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=description content="在上一篇文章《Let’s Encrypt 免费 HTTPS 证书申请》中，介绍了通过 文件验证 的方式申请 Let’s Encrypt 证书，并为 Nginx 配置证书的整个流程。 那么这篇文章来介绍下如何通过 DNS 验证 的方式申请并为 七牛云 配置 SSL 证书。 那么可能会有人说"><meta name=theme-color media="(prefers-color-scheme: light)" content="white"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#0f172a"><meta property="og:title" content="为七牛云配置 Let’s Encrypt 证书"><meta property="og:description" content="在上一篇文章《Let’s Encrypt 免费 HTTPS 证书申请》中，介绍了通过 文件验证 的方式申请 Let’s Encrypt 证书，并为 Nginx 配置证书的整个流程。 那么这篇文章来介绍下如何通过 DNS 验证 的方式申请并为 七牛云 配置 SSL 证书。 那么可能会有人说"><meta property="og:type" content="article"><meta property="og:url" content="https://sxyz.blog/qiniu-tls/"><meta property="og:image" content="https://sxyz.blog/images/others/artwork.jpg"><meta property="article:section" content><meta property="article:published_time" content="2017-07-16T18:24:19+08:00"><meta property="article:modified_time" content="2017-07-16T18:24:19+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sxyz.blog/images/others/artwork.jpg"><meta name=twitter:title content="为七牛云配置 Let’s Encrypt 证书"><meta name=twitter:description content="在上一篇文章《Let’s Encrypt 免费 HTTPS 证书申请》中，介绍了通过 文件验证 的方式申请 Let’s Encrypt 证书，并为 Nginx 配置证书的整个流程。 那么这篇文章来介绍下如何通过 DNS 验证 的方式申请并为 七牛云 配置 SSL 证书。 那么可能会有人说"><title data-site="Sxyazi’s blog">为七牛云配置 Let’s Encrypt 证书 | Sxyazi’s blog</title><link rel=stylesheet href=/assets/index-fad781fe.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=theme-color content="#ffffff"></head><body><main><nav id=nav><a href=/>Home</a><a href=/archives/>Archives</a><a href=/tags/>Tags</a><a href=/links/>Links</a><a href=/about/>About</a></nav><section id=post><h1>为七牛云配置 Let’s Encrypt 证书</h1><time datetime=2017-07-16T18:24:19+0800>07-16</time>
<span>qiniu-tls</span><div><p>在上一篇文章《Let’s Encrypt 免费 HTTPS 证书申请》中，介绍了通过 <code>文件验证</code> 的方式申请 Let’s Encrypt 证书，并为 Nginx 配置证书的整个流程。<p>那么这篇文章来介绍下如何通过 <code>DNS 验证</code> 的方式申请并为 七牛云 配置 SSL 证书。<p>那么可能会有人说，七牛云不是提供了一个 1 年的免费证书申请服务么，为什么你还要自己申请 Let’s Encrypt 的证书再配置，那不是很麻烦么? 其实我也不想啊！但是那东西一直申请失败，提示 <code>CA验证失败</code> ，提交工单说是黑盒申请七牛也无能为力。我猜想可能是我域名后缀不支持吧。<h2 id=01-安装-acmesh>01. 安装 acme.sh</h2><p>全程是通过 acme.sh 这个工具来申请的，所以第一步要先安装一下。<pre><code class=language-bash>curl https://get.acme.sh | sh
</code></pre><h2 id=02-申请证书>02. 申请证书</h2><p>先说下为什么这里使用 <code>DNS 验证</code> 的方式申请验证域名：<blockquote><p>其实原因很简单，因为我域名绑定到了七牛，如果使用 <code>文件验证</code> 的方法申请，那么就要保证在七牛空间里面有这个验证文件，并且还要能够访问到。所以这时候就不太方便了，然后我就选择了 <code>DNS 验证</code> 。</blockquote><p>DNS 验证方式介绍：<blockquote><p>DNS 方式，在域名上添加一条 txt 解析记录，验证域名所有权。<p>DNS 方式的真正强大之处在于可以使用域名解析商提供的 api 自动添加 txt 记录完成验证。<p>acme.sh 目前支持 cloudflare，dnspod，cloudxns，godaddy 以及 ovh 等数十种解析商的自动集成。</blockquote><p>我使用的是 cloudflare，所以执行下面的命令：<pre><code class=language-bash>export CF_Key=&quot;你的API密钥&quot;
export CF_Email=&quot;cloudflare 登录邮箱&quot;

~/.acme.sh/acme.sh --issue --dns dns_cf -d ibllk.pw
</code></pre><p>其他的用法可以参考 <a href=https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md>https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md</a><p>执行上面命令后，会自动使用 api 添加 txt 记录到 cloudflare，并等待 120 秒。<p>等待结束后，会继续进行下一步操作，如果验证通过，那么证书就申请成功了。<h2 id=03-配置证书>03. 配置证书</h2><p>上面的步骤都执行完后，那么就代表证书已经申请成功了。默认证书是存放在 <code>~/.acme.sh/</code> 目录中的。<p>执行下面命令把证书复制到 <code>/root/ibllk/</code> 目录里面：<pre><code class=language-bash>mkdir /root/ibllk
~/.acme.sh/acme.sh  --installcert -d ibllk.pw   \
        --key-file        /root/ibllk/ibllk.pw.key \
        --fullchain-file  /root/ibllk/ibllk.pw.cer
</code></pre><p>其中 <code>ibllk.pw.cer</code> 是证书文件，<code>ibllk.pw.key</code> 是证书的私钥文件。<h2 id=04-证书续期>04. 证书续期</h2><p>acme.sh 能够自动检查证书有效期，并自动续期。安装 acme.sh 后他会添加一条定时任务：<pre><code class=language-bash>crontab -l
8 0 * * * &quot;/root/.acme.sh&quot;/acme.sh --cron --home &quot;/root/.acme.sh&quot; &gt; /dev/null
</code></pre><p>如果发现证书失效，我们刚才执行的命令都会自动重复一遍以完成证书续期。<h2 id=05-七牛自动同步更新证书>05. 七牛自动同步更新证书</h2><p>这个等有时间我拿 Python 写个脚本更新。</div><ul><li><a href=/tags/network>Network</a></ul></section></main><app></app><noscript>You need to enable JavaScript to run this app.</noscript><script type=module crossorigin src=/assets/index-b1ee8dc4.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XWVTHMXTRH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XWVTHMXTRH")</script></body></html>